<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #00ff00;
            height: 100vh;
            overflow: hidden;
        }

        .terminal {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .setup {
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .setup input {
            background: transparent;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 5px 10px;
            margin: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .setup button {
            background: transparent;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 5px 15px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }

        .setup button:hover {
            background: #00ff00;
            color: #000;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .message {
            margin-bottom: 5px;
            word-wrap: break-word;
        }

        .input-line {
            display: flex;
            align-items: center;
            border-top: 1px solid #00ff00;
            padding-top: 10px;
        }

        .prompt {
            color: #00ff00;
            margin-right: 10px;
        }

        #messageInput {
            flex: 1;
            background: transparent;
            border: none;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            outline: none;
        }

        .cursor {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .timestamp {
            opacity: 0.7;
            font-size: 12px;
        }

        .status {
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 12px;
            opacity: 0.7;
            z-index: 100;
        }

        .user-input {
            margin: 10px 0;
        }

        .user-input input {
            width: 200px;
        }
    </style>
</head>
<body>
    <div class="status" id="status">OFFLINE</div>
    
    <div class="terminal">
        <div id="firebaseSetup" class="setup">
            <div>> TERMINAL CHAT v1.0</div>
            <div>></div>
            <div>> Para funcionar entre dispositivos:</div>
            <div>> 1. VÃ¡ em https://console.firebase.google.com</div>
            <div>> 2. Crie projeto -> Realtime Database -> Modo teste</div>
            <div>> 3. Cole URL do database:</div>
            <div class="user-input">
                <span>> </span><input type="text" id="firebaseUrl" placeholder="https://seu-projeto-default-rtdb.firebaseio.com">
            </div>
            <div>
                <button onclick="connectFirebase()">[CONECTAR FIREBASE]</button>
                <button onclick="useLocalMode()">[MODO LOCAL]</button>
            </div>
        </div>

        <div id="chatInterface" style="display: none; height: 100%; flex-direction: column;">
            <div class="messages" id="messages"></div>
            <div class="input-line">
                <span class="prompt">></span>
                <input type="text" id="messageInput" autofocus>
                <span class="cursor">_</span>
            </div>
        </div>
    </div>

    <script>
        let currentUser = '';
        let firebaseUrl = '';
        let chatData = [];
        let isLocal = false;

        function connectFirebase() {
            const url = document.getElementById('firebaseUrl').value.trim();
            if (!url) {
                alert('ERRO: Digite a URL do Firebase!');
                return;
            }
            
            firebaseUrl = url.endsWith('.json') ? url : url + '/messages.json';
            document.getElementById('firebaseSetup').style.display = 'none';
            document.getElementById('chatInterface').style.display = 'flex';
            document.getElementById('status').textContent = 'FIREBASE CONECTADO';
            
            setupChat();
            startFirebasePolling();
        }

        function useLocalMode() {
            isLocal = true;
            document.getElementById('firebaseSetup').style.display = 'none';
            document.getElementById('chatInterface').style.display = 'flex';
            document.getElementById('status').textContent = 'MODO LOCAL';
            
            setupChat();
            startLocalPolling();
        }

        function setupChat() {
            const messageInput = document.getElementById('messageInput');
            
            messageInput.addEventListener('blur', function() {
                setTimeout(() => this.focus(), 10);
            });

            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const message = this.value.trim();
                    if (message.toLowerCase() === 'clear') {
                        clearChatForAll();
                        this.value = '';
                        return;
                    }
                    if (message.toLowerCase() === 'clearall') {
                        clearChatForAll();
                        this.value = '';
                        return;
                    }
                    sendMessage();
                }
            });

            renderMessages();
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) return;
            
            const messageObj = {
                text: message,
                timestamp: new Date().toLocaleTimeString('pt-BR', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                }),
                id: Date.now() + Math.random()
            };
            
            messageInput.value = '';
            
            if (isLocal) {
                chatData.push(messageObj);
                localStorage.setItem('chatData', JSON.stringify(chatData));
                renderMessages();
            } else {
                sendToFirebase(messageObj);
            }
        }

        function sendToFirebase(messageObj) {
            fetch(firebaseUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(messageObj)
            })
            .then(response => response.json())
            .then(data => {
                console.log('> MENSAGEM ENVIADA');
            })
            .catch(error => {
                console.error('> ERRO AO ENVIAR:', error);
                document.getElementById('status').textContent = 'ERRO DE CONEXAO';
            });
        }

        function startFirebasePolling() {
            loadFromFirebase();
            setInterval(loadFromFirebase, 1000);
        }

        function loadFromFirebase() {
            fetch(firebaseUrl)
            .then(response => response.json())
            .then(data => {
                if (data) {
                    chatData = Object.values(data).sort((a, b) => a.id - b.id);
                    renderMessages();
                }
            })
            .catch(error => {
                console.error('> ERRO AO CARREGAR:', error);
            });
        }

        function startLocalPolling() {
            const savedData = localStorage.getItem('chatData');
            if (savedData) {
                chatData = JSON.parse(savedData);
            }
            
            setInterval(() => {
                const savedData = localStorage.getItem('chatData');
                if (savedData) {
                    const newData = JSON.parse(savedData);
                    if (newData.length !== chatData.length) {
                        chatData = newData;
                        renderMessages();
                    }
                }
            }, 500);
        }

        function renderMessages() {
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = '';
            
            if (chatData.length === 0) {
                const welcomeMsg = document.createElement('div');
                welcomeMsg.className = 'message';
                welcomeMsg.innerHTML = '> AGUARDANDO MENSAGENS...';
                messagesContainer.appendChild(welcomeMsg);
                return;
            }
            
            chatData.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.innerHTML = `<span class="timestamp">[${msg.timestamp}]</span> ${msg.text}`;
                messagesContainer.appendChild(messageDiv);
            });
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function clearChatForAll() {
            if (isLocal) {
                // Modo local - limpa localStorage
                localStorage.removeItem('chatData');
                chatData = [];
                renderMessages();
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.innerHTML = '> CHAT LIMPO';
                document.getElementById('messages').appendChild(messageDiv);
            } else {
                // Modo Firebase - deleta todas as mensagens
                fetch(firebaseUrl.replace('/messages.json', '.json'), {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    if (response.ok) {
                        chatData = [];
                        renderMessages();
                        
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'message';
                        messageDiv.innerHTML = '> CHAT LIMPO PARA TODOS';
                        document.getElementById('messages').appendChild(messageDiv);
                    } else {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'message';
                        messageDiv.innerHTML = '> ERRO AO LIMPAR CHAT';
                        document.getElementById('messages').appendChild(messageDiv);
                    }
                })
                .catch(error => {
                    console.error('Erro ao limpar Firebase:', error);
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message';
                    messageDiv.innerHTML = '> ERRO DE CONEXAO AO LIMPAR';
                    document.getElementById('messages').appendChild(messageDiv);
                });
            }
        }

        function clearChat() {
            if (isLocal) {
                localStorage.removeItem('chatData');
                chatData = [];
                document.getElementById('messages').innerHTML = '';
                const welcomeMsg = document.createElement('div');
                welcomeMsg.className = 'message';
                welcomeMsg.innerHTML = '> CHAT LIMPO';
                document.getElementById('messages').appendChild(welcomeMsg);
            } else {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.innerHTML = '> USE "clear" PARA LIMPAR PARA TODOS';
                document.getElementById('messages').appendChild(messageDiv);
            }
        }
    </script>
</body>
</html>